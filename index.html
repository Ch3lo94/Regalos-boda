<!DOCTYPE html>
<html>
<head>
  <base target="_top">

  <style>
    body { font-family: Arial; padding: 20px; }

    .item {
      border: 2px solid transparent;
      padding: 10px;
      margin: 10px;
      text-align: center;
      width: 200px;
      display: inline-block;
      cursor: pointer;
      transition: 0.25s;
      border-radius: 8px;
    }

    .item:hover { transform: scale(1.03); }

    .sel {
      border-color: #0077ff;
      box-shadow: 0 0 10px #0077ff;
    }
  </style>

  <script>
    let usuarioEmail = "";
    let seleccionados = new Set();

    document.addEventListener("DOMContentLoaded", () => {
      google.script.run.withSuccessHandler(iniciarGoogleAuth).getUsuario();
    });

    function iniciarGoogleAuth(user) {
      if (!user || !user.email) {
        document.body.innerHTML = "<h3>No se pudo validar Google OAuth</h3>";
        return;
      }

      usuarioEmail = user.email.toLowerCase();
      verificarEmail();
    }

    function verificarEmail() {
      google.script.run.withSuccessHandler(res => {
        if (res.yaRespondio) {
          document.body.innerHTML = "<h2>Ya completaste tu selección. Gracias!</h2>";
        } else {
          cargarCatalogo();
        }
      }).checkEmail(usuarioEmail);
    }

    function cargarCatalogo() {
      google.script.run.withSuccessHandler(renderRegalos).getRegalos();
    }

    function renderRegalos(lista) {
      document.body.innerHTML = `
        <h2>Seleccioná tus regalos</h2>
        <div id="regalos"></div>
        <br><button onclick="enviar()">Enviar</button>
      `;

      const cont = document.getElementById("regalos");

      lista.forEach(r => {
        const div = document.createElement("div");
        div.className = "item";
        div.dataset.id = r.id;
        div.innerHTML = `
          <img src="${r.imagen}" width="120">
          <h3>${r.nombre}</h3>
        `;
        div.onclick = () => toggle(div);
        cont.appendChild(div);
      });
    }

    function toggle(div) {
      const id = div.dataset.id;

      if (seleccionados.has(id)) {
        seleccionados.delete(id);
        div.classList.remove("sel");
      } else {
        seleccionados.add(id);
        div.classList.add("sel");
      }
    }

    function enviar() {
      if (seleccionados.size === 0) {
        alert("Seleccioná al menos un regalo.");
        return;
      }

      google.script.run.withSuccessHandler(res => {
        if (res.success) {
          alert("Gracias! Tu respuesta fue registrada.");
          location.reload();
        } else {
          alert("Error: " + res.error);
        }
      }).guardarRespuesta(usuarioEmail, Array.from(seleccionados));
    }
  </script>

</head>
<body>
  Cargando...
</body>
</html>
